/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
<<<<<<< HEAD
=======

>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
"use strict";

const RequireContextDependency = require("./RequireContextDependency");

<<<<<<< HEAD
module.exports = class RequireContextDependencyParserPlugin {
=======
/** @typedef {import("../Dependency").DependencyLocation} DependencyLocation */
/** @typedef {import("../javascript/JavascriptParser")} JavascriptParser */
/** @typedef {import("../javascript/JavascriptParser").Range} Range */

module.exports = class RequireContextDependencyParserPlugin {
	/**
	 * @param {JavascriptParser} parser the parser
	 * @returns {void}
	 */
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
	apply(parser) {
		parser.hooks.call
			.for("require.context")
			.tap("RequireContextDependencyParserPlugin", expr => {
				let regExp = /^\.\/.*$/;
				let recursive = true;
				let mode = "sync";
				switch (expr.arguments.length) {
					case 4: {
						const modeExpr = parser.evaluateExpression(expr.arguments[3]);
						if (!modeExpr.isString()) return;
<<<<<<< HEAD
						mode = modeExpr.string;
=======
						mode = /** @type {string} */ (modeExpr.string);
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
					}
					// falls through
					case 3: {
						const regExpExpr = parser.evaluateExpression(expr.arguments[2]);
						if (!regExpExpr.isRegExp()) return;
<<<<<<< HEAD
						regExp = regExpExpr.regExp;
=======
						regExp = /** @type {RegExp} */ (regExpExpr.regExp);
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
					}
					// falls through
					case 2: {
						const recursiveExpr = parser.evaluateExpression(expr.arguments[1]);
						if (!recursiveExpr.isBoolean()) return;
<<<<<<< HEAD
						recursive = recursiveExpr.bool;
=======
						recursive = /** @type {boolean} */ (recursiveExpr.bool);
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
					}
					// falls through
					case 1: {
						const requestExpr = parser.evaluateExpression(expr.arguments[0]);
						if (!requestExpr.isString()) return;
						const dep = new RequireContextDependency(
							{
								request: requestExpr.string,
								recursive,
								regExp,
<<<<<<< HEAD
								mode
							},
							expr.range
						);
						dep.loc = expr.loc;
						dep.optional = parser.scope.inTry;
=======
								mode,
								category: "commonjs"
							},
							/** @type {Range} */ (expr.range)
						);
						dep.loc = /** @type {DependencyLocation} */ (expr.loc);
						dep.optional = !!parser.scope.inTry;
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
						parser.state.current.addDependency(dep);
						return true;
					}
				}
			});
	}
};
