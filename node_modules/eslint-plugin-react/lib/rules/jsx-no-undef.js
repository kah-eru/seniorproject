/**
 * @fileoverview Disallow undeclared variables in JSX
 * @author Yannick Croissant
 */

'use strict';

const docsUrl = require('../util/docsUrl');
const jsxUtil = require('../util/jsx');
<<<<<<< HEAD
=======
const report = require('../util/report');
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd

// ------------------------------------------------------------------------------
// Rule Definition
// ------------------------------------------------------------------------------

<<<<<<< HEAD
=======
const messages = {
  undefined: '\'{{identifier}}\' is not defined.',
};

>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
module.exports = {
  meta: {
    docs: {
      description: 'Disallow undeclared variables in JSX',
      category: 'Possible Errors',
      recommended: true,
<<<<<<< HEAD
      url: docsUrl('jsx-no-undef')
    },
=======
      url: docsUrl('jsx-no-undef'),
    },

    messages,

>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
    schema: [{
      type: 'object',
      properties: {
        allowGlobals: {
<<<<<<< HEAD
          type: 'boolean'
        }
      },
      additionalProperties: false
    }]
  },

  create: function(context) {
=======
          type: 'boolean',
        },
      },
      additionalProperties: false,
    }],
  },

  create(context) {
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
    const config = context.options[0] || {};
    const allowGlobals = config.allowGlobals || false;

    /**
     * Compare an identifier with the variables declared in the scope
     * @param {ASTNode} node - Identifier or JSXIdentifier node
     * @returns {void}
     */
    function checkIdentifierInJSX(node) {
      let scope = context.getScope();
      const sourceCode = context.getSourceCode();
      const sourceType = sourceCode.ast.sourceType;
<<<<<<< HEAD
      let variables = scope.variables;
      let scopeType = 'global';
=======
      const scopeUpperBound = !allowGlobals && sourceType === 'module' ? 'module' : 'global';
      let variables = scope.variables;
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
      let i;
      let len;

      // Ignore 'this' keyword (also maked as JSXIdentifier when used in JSX)
      if (node.name === 'this') {
        return;
      }

<<<<<<< HEAD
      if (!allowGlobals && sourceType === 'module') {
        scopeType = 'module';
      }

      while (scope.type !== scopeType) {
=======
      while (scope.type !== scopeUpperBound && scope.type !== 'global') {
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
        scope = scope.upper;
        variables = scope.variables.concat(variables);
      }
      if (scope.childScopes.length) {
        variables = scope.childScopes[0].variables.concat(variables);
        // Temporary fix for babel-eslint
        if (scope.childScopes[0].childScopes.length) {
          variables = scope.childScopes[0].childScopes[0].variables.concat(variables);
        }
      }

      for (i = 0, len = variables.length; i < len; i++) {
        if (variables[i].name === node.name) {
          return;
        }
      }

<<<<<<< HEAD
      context.report({
        node: node,
        message: `'${node.name}' is not defined.`
=======
      report(context, messages.undefined, 'undefined', {
        node,
        data: {
          identifier: node.name,
        },
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
      });
    }

    return {
<<<<<<< HEAD
      JSXOpeningElement: function(node) {
=======
      JSXOpeningElement(node) {
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
        switch (node.name.type) {
          case 'JSXIdentifier':
            if (jsxUtil.isDOMComponent(node)) {
              return;
            }
            node = node.name;
            break;
          case 'JSXMemberExpression':
            node = node.name;
            do {
              node = node.object;
            } while (node && node.type !== 'JSXIdentifier');
            break;
          case 'JSXNamespacedName':
<<<<<<< HEAD
            node = node.name.namespace;
            break;
=======
            return;
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
          default:
            break;
        }
        checkIdentifierInJSX(node);
<<<<<<< HEAD
      }
    };
  }
=======
      },
    };
  },
>>>>>>> 21d7be62d554915787485641c4ea1187492767dd
};
